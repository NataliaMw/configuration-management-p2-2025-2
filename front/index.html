<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Task Tracker</title>
    
    <style>
        :root {
            --bg: #ffffff;
            --fg: #111827;
            --muted: #6b7280;
            --accent: #2563eb;
            --radius: 8px;
            --max-width: 900px;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--fg);
            padding: 24px;
            display: flex;
            justify-content: center;
        }

        .wrap {
            width: 100%;
            max-width: var(--max-width);
        }

        main {
            background: #f9fafb;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        h1 { margin: 0 0 16px 0; font-size: 1.5rem; }
        
        #add-task-form {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        #new-task-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        button.btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        button.btn:hover { opacity: 0.9; }
        button.btn:disabled { opacity: 0.6; cursor: not-allowed; }

        #task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #task-list li {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
        }

        #task-list li.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        #task-list input[type="checkbox"] {
            margin-right: 12px;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <main>
            <h1>Task Tracker - Grupo 3</h1>
            
            <!-- Formulario único para añadir tareas -->
            <form id="add-task-form">
                <input
                    type="text"
                    id="new-task-input"
                    placeholder="Enter new task..."
                    required
                />
                <button type="submit" class="btn">Add Task</button>
            </form>

            <!-- Lista de tareas -->
            <ul id="task-list" aria-live="polite"></ul>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/tasks';
        
        // Cargar tareas al iniciar
        async function loadTasks() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to fetch tasks');
                const tasks = await response.json();
                renderTasks(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('task-list').innerHTML = 
                    '<li style="color: red;">Error loading tasks. Is the backend running?</li>';
            }
        }

        // Renderizar tareas
        function renderTasks(tasks) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';

            // Convertir objeto a array si es necesario
            const taskArray = Object.values(tasks);

            taskArray.forEach(task => {
                const li = document.createElement('li');
                li.className = task.completed ? 'completed' : '';
                li.dataset.id = task.id || taskArray.indexOf(task);

                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                           onchange="toggleTask(${li.dataset.id}, this.checked)">
                    <span>${task.title}</span>
                `;
                taskList.appendChild(li);
            });
        }

        // Alternar estado de tarea completada
        async function toggleTask(id, completed) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed })
                });

                if (!response.ok) throw new Error('Failed to update task');
                
                // Recargar lista para reflejar cambios
                loadTasks();
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task');
            }
        }

        // Añadir nueva tarea
        document.getElementById('add-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('new-task-input');
            const title = input.value.trim();
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }

            const submitButton = e.target.querySelector('button');
            submitButton.disabled = true;

            try {
                const response = await fetch(`${API_URL}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add task');
                }

                input.value = '';
                loadTasks(); // Recargar lista
            } catch (error) {
                console.error('Error adding task:', error);
                alert(`Error: ${error.message}`);
            } finally {
                submitButton.disabled = false;
            }
        });

        // Cargar tareas al iniciar la aplicación
        loadTasks();
    </script>
</body>
</html>